Specifiche:

Pushare 

- TODO deploy should install the servlet:
  - curl --silent --output /dev/null  --write-out "%{http_code}"  "http://localhost:8080/hello-world"
  - -> 200 not 404

Checklist:

  - mettere il commento nel Vagrant per la porta 8080
  - decidere se il tomcat lo devono mettere i sistemisti o meno
  - sistemare il problema del vim all'avvio
  - verificare che il copia e incolla su vim funziona
  - fare il reset:
    - git rm script/deploy && git commit -m "Reset" script/deploy
  - impostare gli alias:
    - alias c='git commit -m Improved -a'
  - togliere 'Host default' da ~/.ssh-config
  - vagrant destroy && vagrant up

Presentazione:

  - (problema) L'obiettivo è scrivere uno script di deploy che faccia il deploy automatico di un software su un server
  - (problema) Il server è una macchina Vagrant accessibile con "vagrant ssh"
  - (problema) La macchina dovrebbe essere già stata creata e provisionata
  - (problema) Il software da installare cambierà nel tempo, come succede nella realtà.
  - (problema) Immaginatevi che all'inizio sia un software molto semplice

  - (metodo) "To Do List (4)": lavoriamo una feature alla volta
  - (metodo) "To Do List (1)": abbiamo un elenco di feature ("To Do List")
  - (metodo) "To Do List (2)": teniamo aggiornato l'elenco marcando quelle che sono sviluppate 
  - (metodo) "To Do List (3)": teniamo aggiornata l'elenco aggiungendo ogni nuova attività non prevista che diventa necessaria
  - (metodo) "To Do List (5)": se durante la lavorazione di una feature scopriamo che manca qualcosa: 1) fermiamo il lavoro, 2) aggiorniamo la lista, 3) passiamo a lavorare alla nuova priorità ("Mikado Method")
  - (metodo) "To Do List (6)": In genere è possibile e anche normale che la To Do list all'inizio contenga un solo punto e poi, man a mano che il lavoro prosegue si popoli di diversi punti
  - (metodo) "Test First": prima di cominciare a lavorare su una feature progettiamo un modo per verificare che abbiamo finito: "definition of done"
  - (rule) sotto ogni specifica mettiamo il test, il test è un comando della shell che deve passare
  - (rule) usiamo il test dell'exit code per verificare se l'obiettivo è stato raggiunto
  
  - DONE (requisito) single command deploy: script/deploy
  - DONE (requisito) lo script di deploy tocca la macchina (uname -a)
  - DONE (requisito) deve funzionare sia con la vagrant locale che con i server di produzione
  - (requisito) lo script di deploy installa tomcat 
  - (requisito) deployare "Hello World" con file statico
  - (requisito) deployare una specifica versione
  - (requisito) la servlet per funzionare richiede MySQL
  - (requisito) la servlet che richiede il Sun di Oracle
  - (requisito) per testare la servlet bisogna fare una fixture sul database
  - (requisito) la configurazione di connessione al database cambia dall'ambiente di produzione a quello di produzione
  - (spiego) trucco del cd tra parentesi
  - (spiego) l'idempotenza prevista: mkdir -> mkdir -p
  - (spiego) l'idempotenza con sonda: nginx --version || apt-get install nginx -y
  - (spiego) l'idempotenza con sovrascrittura: ln -s -> ln -sf
  - (spiego) l'idempotenza con preparazione: ln -s -> rm -f target && ln -s source target

Notes:

  - pushare il repository sulla macchina:
    - git push ssh://vagrant@default/home/vagrant/repo.git HEAD
  - how to install git:
    - git --version || sudo apt-get install git-core -y
  - how to create a bare repository:
    - ssh default 'mkdir -p repo.git && cd repo.git && git init --bare'
  - how to create the working copy (non idempotent)
    - git clone repo.git/ working-copy
  - idempotent create a working copy
    - mkdir -p working-copy && (
      cd working-copy && 
      git init && 
      ( git remote rm origin || true ) && 
      git remote add -f origin ../repo.git && 
      git fetch -u origin master &&
      git checkout master
      )
  - java servlet compiling:
    - javac -cp lib/servlet-api.jar example/HelloWorld.java
  - copy .class:
    - ssh default 'ls /var/lib/tomcat7/webapps/ROOT/WEB-INF/classes/HelloWorld.class'
  - check tomcat
    - ls downloads/apache-tomcat-7.0.68.tar.gz
  - tomcat has been downloaded from here:  
    - wget http://it.apache.contactlab.it/tomcat/tomcat-7/v7.0.68/bin/apache-tomcat-7.0.68.tar.gz
  - tomcat directories:
    - /etc/default/tomcat7 (file di configurazione)
    - /usr/share/tomcat7-admin/manager (applicazione manager)
    - /usr/share/tomcat7/lib (librerie tomcat)
    - /usr/lib/jvm/java-8-oracle
    - /var/lib/tomcat7/webapps
  - modi per risolvere: zsh: exec format error: script/deploy
    - mettere :
    - mettere true
    - mettere #!/bin/bash
  - barra verde/rossa nel prompt della Bash:
    - PS1="\`if [ \$? = 0 ]; then printf \[\e[32m\]; else printf \[\e[31m\]; fi; printf \\$\e[0m\] \` $PS1"
  - linea Vagrantfile per forwardare tomcat:
    - config.vm.network "forwarded_port", guest: 8080, host: 8080
  - accedere alla vagrant usando ssh pulito:
    - vagrant ssh-config >> ~/.ssh/config
  - copiare un file usando rsync over SSH:
    - rsync Vagrantfile default:
  - ssh -i .vagrant/machines/default/virtualbox/private_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no  -p 2222 -l vagrant  localhost
  - git log  --oneline --graph --color
  - git config --global alias.st "status"
  - alias pazzia:
    - alias improved='diff <(git status --short) - <<< " M hello-world-servlet.txt" && git commit -m "Improved" hello-world-servlet.txt'


TODO:

  - installare MacVim che prende anche la copia tipo commmand+C
  - definire cosa intendo quando dico che lo "script crasha"
  - aggiungere linea di comando che mette l'exit code nel PROMPT
  - curl --silent --output /dev/null --write-out "%{http_code}"  "http://localhost:8080/"
  
- deploy della servlet:
  cp /vagrant/.../HelloWorld.class /var/lib/tomcat7/webapps/ROOT
- data dir:
  - vagrant ssh -c "ls /vagrant"
- don't update all the times
- deployare tomcat
- deployare la servlet
- tutorial http://www.tutorialspoint.com/servlets/servlets-first-example.htm





mkdir -p /var/lib/tomcat7/webapps/ROOT/WEB-INF/web.xml
cat >/var/lib/tomcat7/webapps/ROOT/WEB-INF/web.xml << \'
<servlet>
   <servlet-name>HelloWorld</servlet-name>
   <servlet-class>HelloWorld</servlet-class>
</servlet>

<servlet-mapping>
   <servlet-name>HelloWorld</servlet-name>
   <url-pattern>/HelloWorld</url-pattern>
</servlet-mapping>
'
